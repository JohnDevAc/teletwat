<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tvheadend → NDI Bridge</title>
  <link rel="stylesheet" href="/static/common.css">
  
</head>

<body>
<div class="wrap">
  <header>
    <div class="title">
      <h1 class="srOnly">Tvheadend → NDI Bridge</h1>
      <div class="sub">Select a channel, name the NDI source, and publish it on your LAN.</div>
    </div>
        <div class="rightTop">
            <a class="miniBtn" data-tvh-link href="#">TV-Headend</a>
<a class="miniBtn" href="/aes67">AES67</a>
            <a class="miniBtn" href="/system">System</a>
<div class="pill" title="NDI running state">
      <span id="dot" class="dot"></span>
      <span id="statusText">STOPPED</span>
    </div>
      <img class="brandLogo" src="/static/TeleTwat_V1_0_all_black_transparent.png" alt="TeleTwat logo" />
    </div>
  </header>

  <div class="grid">
    <div class="card">
      <h2>Control</h2>

      <div class="row">
        <div class="field">
          <label for="channel">Tvheadend channel</label>
          <select id="channel"></select>
        </div>

        <div class="field">
          <label for="ndiname">NDI source name</label>
          <input id="ndiname" placeholder="e.g. BROADCASTPI 1" value="BROADCASTPI Test" />
        </div>
      </div>


      <div class="row" style="margin-top:8px;">
        <div class="field">
          <label for="ndi_mcast_mode">NDI Multicast</label>
          <select id="ndi_mcast_mode">
            <option value="disabled">Disabled</option>
            <option value="enabled">Enabled</option>
          </select>
        </div>
      </div>

      <div id="ndiMcastFields" class="row hidden" style="margin-top:4px;">
        <div class="field">
          <label for="ndi_mcast_addr">Multicast address</label>
          <input id="ndi_mcast_addr" placeholder="e.g. 239.69.0.1" />
        </div>
        <div class="field">
          <label for="ndi_mcast_ttl">TTL</label>
          <input id="ndi_mcast_ttl" type="number" min="0" max="255" value="1" />
        </div>
      </div>
      <div class="actions">
        <button id="start" class="primary">Start NDI</button>
        <button id="stop" class="danger">Stop</button>
        <span id="toast" class="toast"></span>
      </div>

      <div class="hint">
        Tip: keep NDI names unique (e.g. <span class="mono">BROADCASTPI 1</span>, <span class="mono">BROADCASTPI 2</span>).
      </div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between;">
        <h2 style="margin:0;">Live monitoring</h2>
        <div class="rightTop">
          <span id="alertBadge" class="badge" style="display:none;"></span>
          <button id="refresh" class="miniBtn">Refresh</button>
        </div>
      </div>

      <div class="stats">
        <div class="stat">
          <div class="k">Pipeline state</div>
          <div id="st_state" class="v">NULL</div>
        </div>
        <div class="stat">
          <div class="k">Uptime</div>
          <div id="st_uptime" class="v">—</div>
        </div>

        <div class="stat" style="grid-column:1 / -1;">
          <div class="k">NDI name</div>
          <div id="st_ndi" class="v mono">—</div>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="/static/common.js"></script>
<script>
function setRunningUI(running){
  const dot = document.getElementById("dot");
  const statusText = document.getElementById("statusText");
  dot.classList.toggle("ok", !!running);
  statusText.textContent = running ? "RUNNING" : "STOPPED";
}



function setFormDisabled(disabled){
  const ids = ["channel","ndiname","ndi_mcast_mode","ndi_mcast_addr","ndi_mcast_ttl"];
  for (const id of ids){
    const el = document.getElementById(id);
    if (el) el.disabled = !!disabled;
  }
  // Start button should be disabled if already active
  const startBtn = document.getElementById("start");
  if (startBtn) startBtn.disabled = !!disabled;
}


function updateMcastUI(){
  const mode = document.getElementById("ndi_mcast_mode");
  const fields = document.getElementById("ndiMcastFields");
  if (!mode || !fields) return;
  const enabled = (mode.value === "enabled");
  fields.classList.toggle("hidden", !enabled);
}

function populateFormFromStatus(st){
  if (!st || !st.running) return;
  const ch = document.getElementById("channel");
  if (ch && st.channel_uuid) ch.value = st.channel_uuid;
  const n = document.getElementById("ndiname");
  if (n && st.ndi_name) n.value = st.ndi_name;

  const mode = document.getElementById("ndi_mcast_mode");
  const addr = document.getElementById("ndi_mcast_addr");
  const ttl = document.getElementById("ndi_mcast_ttl");

  if (mode) mode.value = st.ndi_multicast_enabled ? "enabled" : "disabled";
  if (addr) addr.value = st.ndi_multicast_addr || "";
  if (ttl && (st.ndi_multicast_ttl !== null && st.ndi_multicast_ttl !== undefined)) ttl.value = String(st.ndi_multicast_ttl);
  updateMcastUI();
}

function setAlertBadge(kind, text){
  const b = document.getElementById("alertBadge");
  if (!text){
    b.style.display = "none";
    b.textContent = "";
    b.className = "badge";
    return;
  }
  b.style.display = "inline-flex";
  b.textContent = text;
  b.className = "badge " + (kind || "");
}

async function loadChannels() {
  const data = await jget("/api/channels");
  const sel = document.getElementById("channel");
  sel.innerHTML = "";
  for (const c of data.channels) {
    const opt = document.createElement("option");
    const num = (c.number !== null && c.number !== undefined) ? String(c.number).padStart(3,"0")+" " : "";
    opt.value = c.uuid;
    opt.textContent = num + c.name;
    sel.appendChild(opt);
  }
}

async function refreshStatus() {
  const st = await jget("/api/status?lite=1");
  const running = !!st.running;
  setRunningUI(running);
  setFormDisabled(running);
  if (running) populateFormFromStatus(st);

  document.getElementById("st_state").textContent = st.pipeline_state || (running ? "PLAYING" : "NULL");
  document.getElementById("st_uptime").textContent = running ? fmtUptime(st.started_at) : "—";
  document.getElementById("st_ndi").textContent = running ? (st.ndi_name || "—") : "—";

  if (st.last_error){
    setAlertBadge("bad", st.last_error);
  } else if (st.last_warning){
    setAlertBadge("warn", st.last_warning);
  } else {
    setAlertBadge("", "");
  }
}

document.getElementById("start").addEventListener("click", async () => {
  const uuid = document.getElementById("channel").value;
  const ndi = document.getElementById("ndiname").value.trim();
  if (!ndi){
    toast("Please enter an NDI name.", "bad");
    return;
  }

  const st = await jget("/api/status?lite=1");
  if (st.running){
    toast("NDI is already running.", "warn");
    await refreshStatus();
    return;
  }
  toast("Starting…");
  document.getElementById("start").disabled = true;

  try {
        const mcastEnabled = (document.getElementById("ndi_mcast_mode").value === "enabled");
    const mcastAddr = document.getElementById("ndi_mcast_addr").value.trim();
    const mcastTtl = parseInt(document.getElementById("ndi_mcast_ttl").value, 10);

    if (mcastEnabled && !mcastAddr){
      toast("Multicast is enabled: please enter a multicast address.", "bad");
      return;
    }

    await jpost("/api/start", {
      channel_uuid: uuid,
      ndi_name: ndi,
      ndi_multicast_enabled: mcastEnabled,
      ndi_multicast_addr: mcastAddr,
      ndi_multicast_ttl: isFinite(mcastTtl) ? mcastTtl : 1,
    });
    toast("NDI started.");
  } catch (e) {
    toast("Start failed: " + e, "bad");
  } finally {
    // refreshStatus() will re-apply the correct disabled state if the stream started.
    document.getElementById("start").disabled = false;
  }
  await refreshStatus();
});

document.getElementById("stop").addEventListener("click", async () => {
  toast("Stopping…");
  document.getElementById("stop").disabled = true;
  try {
    await jpost("/api/stop", {});
    toast("Stopped.");
  } catch (e) {
    toast("Stop failed: " + e, "bad");
  } finally {
    document.getElementById("stop").disabled = false;
  }
  await refreshStatus();
});

document.getElementById("refresh").addEventListener("click", refreshStatus);

(async () => {
  await loadChannels();

  const mode = document.getElementById("ndi_mcast_mode");
  if (mode) mode.addEventListener("change", updateMcastUI);
  updateMcastUI();

  await refreshStatus();
  setInterval(refreshStatus, 2000);
})();
</script>
</body>
</html>