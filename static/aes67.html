<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tvheadend → AES67 Bridge</title>
  <link rel="stylesheet" href="/static/common.css">
  
</head>

<body>
<div class="wrap">
  <header>
    <div class="title">
      <h1 class="srOnly">Tvheadend → AES67 Bridge</h1>
      <div class="sub">Publish an AES67-compatible RTP/L16 multicast audio stream, with SAP discovery.</div>
    </div>
    <div class="rightTop">
            <a class="miniBtn" data-tvh-link href="#">TV-Headend</a>
<a class="miniBtn" href="/">NDI</a>
            <a class="miniBtn" href="/system">System</a>
<div class="pill" title="AES67 running state">
        <span id="dot" class="dot"></span>
        <span id="statusText">STOPPED</span>
      </div>
      <img class="brandLogo" src="/static/TeleTwat_V1_0_all_black_transparent.png" alt="TeleTwat logo" />
    </div>
  </header>

  <div class="grid">
    <div class="card">
      <h2>Control</h2>

      <div class="row">
        <div class="field">
          <label for="mcast">Multicast address</label>
          <input id="mcast" placeholder="e.g. 239.69.0.1" value="239.69.0.1" />
        </div>

        <div class="field">
          <label for="port">RTP port</label>
          <input id="port" placeholder="5004" value="5004" inputmode="numeric" />
        </div>
      </div>

      <div class="row">
        <div class="field">
          <label for="ptime">Packet time (ptime ms)</label>
          <select id="ptime">
            <option value="1">1 ms (AES67 low-latency)</option>
            <option value="2">2 ms</option>
            <option value="5">5 ms (lower packet rate)</option>
          </select>
        </div>
        <div class="field">
          <label for="sap">SAP group</label>
          <input id="sap" placeholder="224.2.127.254" value="224.2.127.254" />
        </div>
      </div>

      <div class="actions">
        <button id="start" class="primary">Start AES67</button>
        <button id="stop" class="danger">Stop</button>
        <span id="toast" class="toast"></span>
      </div>

      <div class="small" style="margin-top:8px;">
        AES67 is gated on NDI: you must have an NDI feed running first, and AES67 will always follow the active NDI channel.
      </div>
    </div>


    <div class="card">
      <h2>SDP</h2>
      <div class="small" style="margin-top:-6px;">
        Paste this into a receiver (e.g. VLC) or import into your audio tool. The Copy button uses a safe fallback if clipboard permissions are blocked.
      </div>

      <textarea id="sdp" class="mono" readonly style="width:100%; min-height:180px; margin-top:10px; padding:12px; border-radius:12px; border:1px solid var(--border); background:#0b111a; color:var(--text);"></textarea>

      <div class="actions" style="margin-top:10px;">
        <button id="copySdp" class="miniBtn" type="button">Copy SDP</button>
        <button id="downloadSdp" class="miniBtn" type="button">Download SDP</button>
      </div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between;">
        <h2 style="margin:0;">Live monitoring</h2>
        <div class="rightTop">
          <span id="alertBadge" class="badge" style="display:none;"></span>
          <button id="refresh" class="miniBtn">Refresh</button>
        </div>
      </div>

      <div class="stats">
        <div class="stat">
          <div class="k">NDI status</div>
          <div id="st_ndi" class="v">—</div>
        </div>
        <div class="stat">
          <div class="k">AES67 pipeline</div>
          <div id="st_state" class="v">NULL</div>
        </div>
<div class="stat">
          <div class="k">RTP multicast</div>
          <div id="st_mcast" class="v mono">—</div>
        </div>
        <div class="stat">
          <div class="k">RTP port</div>
          <div id="st_port" class="v mono">—</div>
        </div>
</div>

      <details>
        <summary>
          <span>Pipeline log</span>
          <span class="small">last 120 lines</span>
        </summary>
        <pre id="log" class="mono"></pre>
      </details>
    </div>
  </div>
</div>

<script src="/static/common.js"></script>
<script>
// Page-specific AES67 logic. Shared helpers live in /static/common.js

function setRunningUI(running){
  const dot = document.getElementById("dot");
  const statusText = document.getElementById("statusText");
  dot.classList.toggle("ok", !!running);
  statusText.textContent = running ? "RUNNING" : "STOPPED";
}

function setAlertBadge(kind, text){
  const b = document.getElementById("alertBadge");
  if (!b) return;
  if (!text){
    b.style.display = "none";
    b.textContent = "";
    b.className = "badge";
    return;
  }
  b.style.display = "inline-flex";
  b.textContent = text;
  b.className = "badge " + (kind || "");
}

function isValidMcast(ip){
  const m = String(ip||"").trim().match(/^(\d+)\.(\d+)\.(\d+)\.(\d+)$/);
  if (!m) return false;
  const a = m.slice(1).map(Number);
  if (a.some(n => !Number.isFinite(n) || n<0 || n>255)) return false;
  return a[0] >= 224 && a[0] <= 239;
}

async function refreshStatus(){
  let ndi = null, st = null;
  try{
    ndi = await jget("/api/status?lite=1");
  }catch(e){
    toast("Failed to fetch NDI status", "bad");
    ndi = {running:false};
  }
  try{
    st = await jget("/api/aes67/status");
  }catch(e){
    toast("Failed to fetch AES67 status", "bad");
    st = {running:false};
  }

  const ndiRunning = !!ndi.running;
  const aesRunning = !!st.running;

  setRunningUI(aesRunning);

  const startBtn = document.getElementById("start");
  const stopBtn = document.getElementById("stop");
  if (startBtn) startBtn.disabled = !ndiRunning || aesRunning;
  if (stopBtn) stopBtn.disabled = !aesRunning;

  document.getElementById("st_ndi").textContent = ndiRunning ? "RUNNING" : "STOPPED";
  document.getElementById("st_state").textContent = st.pipeline_state || (aesRunning ? "PLAYING" : "NULL");
  document.getElementById("st_mcast").textContent = aesRunning ? (st.multicast_addr || "—") : "—";
  document.getElementById("st_port").textContent = aesRunning ? String(st.rtp_port || "—") : "—";
  // Input field removed from UI; avoid touching a non-existent element.

  const lines = (st.last_log || []);
  document.getElementById("log").textContent = lines.join("\n");

  // Be tolerant of older/newer API shapes (some endpoints wrap under {status:{...}})
  const sdp = (st && (st.sdp || (st.status && st.status.sdp))) || "";
  document.getElementById("sdp").value = sdp;

  // Simple warning badge if user tries to start AES67 without NDI
  if (!ndiRunning){
    setAlertBadge("warn", "Start an NDI stream first");
  }else if (aesRunning){
    setAlertBadge("good", "AES67 running");
  }else{
    setAlertBadge("", "");
  }
}

function downloadText(filename, text){
  const blob = new Blob([String(text||"")], {type:"application/sdp"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 0);
}

function wireUI(){
  document.getElementById("refresh").addEventListener("click", refreshStatus);

  document.getElementById("start").addEventListener("click", async () => {
    const mcast = document.getElementById("mcast").value.trim();
    const port = parseInt(document.getElementById("port").value, 10);
    const sap = document.getElementById("sap").value.trim();
    const ptime = parseInt(document.getElementById("ptime").value, 10) || 1;

    if (!isValidMcast(mcast)){
      toast("Invalid multicast address (must be 224.0.0.0–239.255.255.255)", "bad");
      return;
    }
    if (!Number.isFinite(port) || port<1 || port>65535){
      toast("Invalid RTP port", "bad");
      return;
    }

    try{
      await jpost("/api/aes67/start", {
        multicast_addr: mcast,
        rtp_port: port,
        sap_mcast: sap,
        ptime_ms: ptime
      });
      toast("AES67 started", "good");
    }catch(e){
      // API returns a text body with detail; show it
      toast(String(e.message || e), "bad", 4500);
    }
    await refreshStatus();
  });

  document.getElementById("stop").addEventListener("click", async () => {
    try{
      await jpost("/api/aes67/stop", {});
      toast("AES67 stopped", "good");
    }catch(e){
      toast(String(e.message || e), "bad", 4500);
    }
    await refreshStatus();
  });

  document.getElementById("copySdp").addEventListener("click", async () => {
    const txt = document.getElementById("sdp").value || "";
    if (!txt.trim()){ toast("No SDP to copy", "warn"); return; }
    await copyText(txt);
  });

  document.getElementById("downloadSdp").addEventListener("click", () => {
    const txt = document.getElementById("sdp").value || "";
    if (!txt.trim()){ toast("No SDP to download", "warn"); return; }
    downloadText("aes67.sdp", txt);
  });
}

(async () => {
  // Load defaults (non-fatal)
  try{
    const d = await jget("/api/aes67/defaults");
    if (d.multicast_addr) document.getElementById("mcast").value = d.multicast_addr;
    if (d.rtp_port) document.getElementById("port").value = String(d.rtp_port);
    if (d.sap_mcast) document.getElementById("sap").value = d.sap_mcast;
    if (d.ptime_ms) document.getElementById("ptime").value = String(d.ptime_ms);
  }catch(e){}

  wireUI();
  await refreshStatus();
  setInterval(refreshStatus, 2000);
})();
</script>
</body>
</html>
