<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tvheadend → System</title>
  <link rel="stylesheet" href="/static/common.css">
  
</head>

<body>
<div class="wrap">
  <header>
    <div class="title">
      <h1>System</h1>
      <div class="sub">Device controls, network configuration, and hostname.</div>
    </div>

    <div class="rightTop">
            <a class="miniBtn" data-tvh-link href="#">TV-Headend</a>
<a class="miniBtn" href="/">NDI</a>
      <a class="miniBtn" href="/aes67">AES67</a>
      <div class="pill" title="Backend/API health">
        <span id="dot" class="dot"></span>
        <span id="statusText">CONNECTING</span>
      </div>
      <img class="brandLogo" src="/static/TeleTwat_V1_0_all_black_transparent.png" alt="TeleTwat logo" />
    </div>
  </header>

  <div class="grid">

    <div class="card">
      <h2>Power</h2>
      <div class="row">
        <button id="restartProgram" class="primary">Restart program</button>
        <button id="rebootPi" class="danger">Reboot Pi</button>
        <span id="toastPower" class="toast"></span>
      </div>
      <div class="small" style="margin-top:8px;">
        “Restart program” will exit the current process so your service manager (systemd) can restart it.
        “Reboot Pi” requires passwordless sudo for the reboot command.
      </div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between;">
        <h2 style="margin:0;">Network</h2>
        <span id="netBadge" class="badge" style="display:none;"></span>
      </div>

      <div class="stats">
        <div class="stat">
          <div class="k">Interface</div>
          <div id="st_iface" class="v mono">—</div>
        </div>
        <div class="stat">
          <div class="k">Mode</div>
          <div id="st_mode" class="v">—</div>
        </div>
        <div class="stat">
          <div class="k">IPv4</div>
          <div id="st_ip" class="v mono">—</div>
        </div>
        <div class="stat">
          <div class="k">Gateway</div>
          <div id="st_gw" class="v mono">—</div>
        </div>
        <div class="stat" style="grid-column:1 / -1;">
          <div class="k">DNS</div>
          <div id="st_dns" class="v mono" style="word-break:break-all;">—</div>
        </div>
      </div>

      <div class="row" style="margin-top:12px;">
        <div class="field">
          <label for="iface">Interface (advanced)</label>
          <input id="iface" placeholder="e.g. eth0" />
        </div>
        <div class="field">
          <label for="mode">Addressing</label>
          <select id="mode">
            <option value="dhcp">DHCP (automatic)</option>
            <option value="manual">Manual (static)</option>
          </select>
        </div>
      </div>

      <div id="manualFields" class="row hidden" style="margin-top:4px;">
        <div class="field">
          <label for="ip">Static IPv4 (CIDR)</label>
          <input id="ip" placeholder="e.g. 192.168.1.50/24" />
        </div>
        <div class="field">
          <label for="gw">Gateway</label>
          <input id="gw" placeholder="e.g. 192.168.1.1" />
        </div>
        <div class="field">
          <label for="dns">DNS (space-separated)</label>
          <input id="dns" placeholder="e.g. 1.1.1.1 8.8.8.8" />
        </div>
      </div>

      <div class="actions">
        <button id="applyNetwork" class="primary">Apply network settings</button>
        <button id="refreshNet" class="miniBtn" type="button">Refresh</button>
        <span id="toastNet" class="toast"></span>
      </div>

      <div class="small" style="margin-top:8px;">
        Note: applying network settings may briefly drop this web UI if the IP changes.
      </div>
    </div>

    <div class="card">
      <h2>Hostname</h2>

      <div class="row">
        <div class="field">
          <label>Current hostname</label>
          <div id="currentHostnameText" class="mono" style="padding:10px 12px; border:1px solid #2a2a2a; border-radius:12px; background:#141414;">—</div>
        </div>
        <div class="field">
          <label for="newHostname">New hostname</label>
          <input id="newHostname" placeholder="e.g. broadcastpi-1" />
        </div>
      </div>

      <div class="actions">
        <button id="applyHostname" class="primary">Change hostname</button>
        <span id="toastHost" class="toast"></span>
      </div>

      <div class="small" style="margin-top:8px;">
        Reboot required to apply changes.
      </div>
    </div>

  </div>
</div>

<script src="/static/common.js"></script>
<script>
// NOTE: system.html had drifted out of sync with /static/common.js.
// That caused JS errors (and therefore no values displayed).
// The helpers below bridge that gap without changing other pages.

function netFieldFocused(){
  const a = document.activeElement;
  if (!a) return false;
  return ["iface","mode","ip","gw","dns"].includes(a.id);
}



function setHealth(ok){
  const dot = document.getElementById("dot");
  const t = document.getElementById("statusText");
  dot.classList.toggle("ok", !!ok);
  dot.classList.toggle("bad", ok === false);
  t.textContent = ok ? "ONLINE" : "OFFLINE";
}

function setBadgeId(id, kind, text){
  const b = document.getElementById(id);
  if (!b) return;
  if (!text){
    b.style.display = "none";
    b.textContent = "";
    b.className = "badge";
    return;
  }
  b.style.display = "inline-flex";
  b.textContent = text;
  b.className = "badge " + (kind || "");
}

function toastId(id, msg, isBad=false, ms=2600){
  const el = document.getElementById(id);
  if (!el) { console.log("[toast]", msg); return; }
  el.textContent = msg;
  el.classList.remove("good","bad","warn");
  el.classList.add(isBad ? "bad" : "good");
  el.classList.add("show");
  setTimeout(() => el.classList.remove("show"), ms);
}

function setManualVisible(){
  const mode = document.getElementById("mode").value;
  document.getElementById("manualFields").classList.toggle("hidden", mode !== "manual");
}


// Lock network form when user interacts, so background refresh doesn't overwrite selections.

["mode","iface","ip","gw","dns"].forEach(id => {
  const el = document.getElementById(id);
  if (!el) return;
  el.addEventListener("change", () => {
    lockNetworkFormFor(20000);
    if (id === "mode") setManualVisible();
  });
  el.addEventListener("input", () => lockNetworkFormFor(20000));
});

async function refreshHostname(){
  try{
    const info = await jget("/api/system/hostname");
    const hn = (typeof info.hostname === "string") ? info.hostname : "";
    const ch = document.getElementById("currentHostnameText");
    if (ch) ch.textContent = hn || "—";
    if (!document.activeElement || document.activeElement.id !== "newHostname"){
      document.getElementById("newHostname").placeholder = hn || "e.g. broadcastpi-1";
    }
  } catch(e){
    // Hostname read is non-critical; keep UI responsive.
  }
}

async function refreshNetwork(){
  try{
    const info = await jget("/api/system/network_info");
    setHealth(true);

    // Network
    const n = (info && info.network) ? info.network : {};
    document.getElementById("st_iface").textContent = n.iface || "—";
    document.getElementById("st_mode").textContent = (n.mode || "—").toUpperCase();
    document.getElementById("st_ip").textContent = n.ipv4 || "—";
    document.getElementById("st_gw").textContent = n.gateway || "—";
    document.getElementById("st_dns").textContent = (n.dns && n.dns.length) ? n.dns.join(" ") : "—";

    if (!isNetworkFormLocked() && !netFieldFocused()){
      document.getElementById("iface").value = n.iface || "";
      document.getElementById("mode").value = n.mode || "dhcp";
      document.getElementById("ip").value = n.ipv4 || "";
      document.getElementById("gw").value = n.gateway || "";
      document.getElementById("dns").value = (n.dns && n.dns.length) ? n.dns.join(" ") : "";
      setManualVisible();
    }

    if (info.warnings && info.warnings.length){
      setBadgeId("netBadge", "warn", info.warnings[0]);
    } else {
      setBadgeId("netBadge", "", "");
    }
  } catch(e){
    // Don't spam toast for network discovery failures; just show badge and keep UI
    setBadgeId("netBadge", "warn", "Network refresh failed");
  }
}

async function refreshAll(){
  await Promise.all([refreshHostname(), refreshNetwork()]);
}

document.getElementById("mode").addEventListener("change", () => {
  lockNetworkFormFor(20000);
  setManualVisible();
});

["iface","ip","gw","dns"].forEach(id => {
  const el = document.getElementById(id);
  el.addEventListener("input", () => lockNetworkFormFor(20000));
  el.addEventListener("focus", () => lockNetworkFormFor(20000));
});

document.getElementById("refreshNet").addEventListener("click", refreshAll);

document.getElementById("applyNetwork").addEventListener("click", async () => {
  toastId("toastNet", "Applying…");
  const mode = document.getElementById("mode").value;
  const iface = document.getElementById("iface").value.trim();
  const payload = { mode, iface: iface || null };

  if (mode === "manual"){
    payload.ipv4 = document.getElementById("ip").value.trim();
    payload.gateway = document.getElementById("gw").value.trim();
    payload.dns = document.getElementById("dns").value.trim();

    if (!payload.ipv4){
      toastId("toastNet", "Manual mode needs a static IPv4 address (CIDR), e.g. 192.168.1.50/24", true);
      return;
    }
  }

  try{
    const r = await jpost("/api/system/network", payload);
    toastId("toastNet", r.message || "Network updated.");
    if (r.warning) setBadgeId("netBadge", "warn", r.warning);
  } catch(e){
    toastId("toastNet", "Network update failed: " + e, true);
  }
  // may drop connection if IP changed; this refresh is best-effort
  setTimeout(refreshAll, 1200);
});

document.getElementById("applyHostname").addEventListener("click", async () => {
  const hn = document.getElementById("newHostname").value.trim();
  if (!hn){
    toastId("toastHost", "Please enter a hostname.", true);
    return;
  }
  toastId("toastHost", "Applying…");
  try{
    const r = await jpost("/api/system/hostname", { hostname: hn });
    toastId("toastHost", r.message || "Hostname updated.");
    document.getElementById("newHostname").value = "";
  } catch(e){
    toastId("toastHost", "Hostname update failed: " + e, true);
  }
  setTimeout(refreshHostname, 800);
});

document.getElementById("restartProgram").addEventListener("click", async () => {
  toastId("toastPower", "Restarting program…");
  try{
    const r = await jpost("/api/system/restart_program", {});
    toastId("toastPower", r.message || "Restart requested.");
  } catch(e){
    toastId("toastPower", "Restart failed: " + e, true);
  }
});

document.getElementById("rebootPi").addEventListener("click", async () => {
  toastId("toastPower", "Rebooting…");
  try{
    const r = await jpost("/api/system/reboot", {});
    toastId("toastPower", r.message || "Reboot requested.");
  } catch(e){
    toastId("toastPower", "Reboot failed: " + e, true);
  }
});

(async () => {
  await refreshAll();
  setInterval(refreshNetwork, 10000);
})();
</script>
</body>
</html>
